# Microsoft.LinuxTracepoints.Provider

.NET library for logging Linux user_events Tracepoints with EventHeader encoding.

Requires TargetFramework `net6.0` or later.

See [ProviderSample](../ProviderSample/README.md) for example usage.

## Usage for direct Tracepoint events

- At component initialization, create
  `tracepoint = new PerfTracepoint("MyTracepointName int Field1; int Field2")` to
  create a tracepoint. Use the tracepoint command format described in the
  [user_events](https://docs.kernel.org/trace/user_events.html#command-format)
  documentation.

- Check the `tracepoint.IsEnabled` property to efficiently determine whether any
  tracepoint collection session is collecting data from your tracepoint. This
  allows you to skip preparing data and calling Write when nobody is collecting
  your event.

- Call `tracepoint.Write(eventData...)` with 0 to 5 `ReadOnlySpan<T>` eventData args
  to write an event to your tracepoint. If no tracepoint collection session is
  collecting data from your tracepoint, the `Write` method will immediately return
  EBADF. Otherwise, the `Write` method will concatenate the values of the eventData
  args and write an event with the specified data.

- Call `tracepoint.Dispose()` to unregister your tracepoint.

- For debugging or diagnostic purposes, check the `tracepoint.RegisterResult`
  property to determine the errno returned during tracepoint registration.

Note that if the tracepoint is unregistered (i.e. if registration failed or if the
tracepoint is disposed), the IsEnabled property and Write method are safe no-ops.

## Usage for EventHeader-encoded events

- At component initialization, create
  `provider = new EventHeaderDynamicProvider("MyCompany_MyOrg_MyComponent")` to
  create a provider that will manage tracepoints for your component.

- For best behavior, call `provider.Register(level, keyword)` for each
  level/keyword combination that will be used by your component.

  - Registering all necessary combinations at startup rather than on-first-use
    helps event consumers see which level/keyword combinations might be generated by
    your component, making it easier for them to collect all of the combinations they
    need to collect.

  - You might want to cache the tracepoints returned by `Register` if you want to
    avoid the overhead of looking them up later.

- When you need to generate an event with a particular level/keyword combination:

  - Use `tracepoint = provider.FindOrRegister(level, keyword)` to access the
    tracepoint for the event (or use `provider.Find(...)` if you know that the tracepoint
    has already been registered, or use a cached value if you cached the tracepoint
    returned by `provider.Register(...)`).

  - Check `tracepoint.IsEnabled` to determine whether any consumer is collecting the
    tracepoint's data. If it returns false, there is no need to write the event so you can
    skip the remaining steps.

  - Create a `builder = new EventHeaderDynamicBuilder()` for building the event (or use a
    previously-allocated builder to minimize overhead/garbage).

  - Call `builder.Reset("MyEventName")` to start building your event.

  - Call builder methods as appropriate to add fields to the event or to configure event
    attributes like tag, opcode, id, or version.

  - Call `builder.Write(tracepoint)` to write the builder's event to the tracepoint.

  - Call `builder.Dispose()` to return the builder's temporary buffers to the array pool.

- At component cleanup, call `provider.Dispose()` to unregister all tracepoints.

## Changelog

### 0.1.3 (TBD)

- Initial release.
